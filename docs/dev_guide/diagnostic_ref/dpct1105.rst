.. _id_DPCT1105:

DPCT1105
========

Message
-------

.. _msg-1105-start:

``<expression text>`` should point to a dynamic library loaded in memory. The dynamic
library should supply wrapped kernel functions. Compilation options passed to
``cuModuleLoadDataEx`` are not migrated.

.. _msg-1105-end:

Detailed Help
-------------

The CUDA application expects ``<expression text>`` to point to a CUDA module whose
file image has been copied to memory.  The user should ensure that the CUDA code
that generated the CUDA module is migrated to SYCL code, compiled to generate a
kernel library, and then copied to memory by the migrated SYCL application.
The CUDA compilation options passed to cuModuleLoadDataEx are removed from the migrated
code.

Suggestions to Fix
------------------

The user should find the module source file(s) that are used to make the CUDA module
and migrate them to SYCL with the --extra-arg=-ptx option of the compatibility tool
to generate "wrapped" kernel functions:

.. code-block:: bash
   :linenos:
   dpct <module source file(s)> --extra-arg=--ptx
The migrated module source file(s) should be compiled to make a kernel library.
On Linux:

.. code-block:: bash
   :linenos:
   icpx -fsycl <migrated module source file(s)> -fPIC -shared -o <kernel library filename>
On Windows:

.. code-block:: bash
   :linenos:
   icpx -fsycl <migrated module source file(s)> -shared -o <kernel library filename>
The user should ensure that the application will load the kernel library image into
memory at runtime. For the following example this can be ensured by setting
``<kernel library filename>`` to "module.ptx".  The CUDA compilation options should
also be deleted.

Example:

Original code:

.. code-block:: cpp
   :linenos:
   const unsigned int jitNumOptions = 1;
   CUjit_option  jitOptions[jitNumOptions];
   void         *jitOptVals[jitNumOptions];
   
   // set up wall clock time
   jitOptions[0] = CU_JIT_WALL_TIME;
   
   const void *image = copyFileToMemory("module.ptx");
   cuModuleLoadDataEx(&module,image, jitNumOptions, jitOptions, (void **)jitOptVals);
Migrated code:

.. code-block:: cpp
   :linenos:
   const unsigned int jitNumOptions = 1;
   CUjit_option  jitOptions[jitNumOptions];
   void         *jitOptVals[jitNumOptions];  
   
   // set up wall clock time
   jitOptions[0] = CU_JIT_WALL_TIME;
   
   const void *image = copyFileToMemory("module.ptx");
   module = dpct::load_kernel_library(image);
Fixed code:

.. code-block:: cpp
   :linenos:
   const void *image = copyFileToMemory("module.ptx");
   module = dpct::load_kernel_library(image);
